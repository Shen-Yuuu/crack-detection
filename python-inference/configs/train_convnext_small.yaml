# 裂纹检测训练配置

# 数据集配置
dataset:
  root: "../data/processed"
  image_dir: "images"
  mask_dir: "masks"
  crop_size: [640, 640]
  train_scales: [[512, 512], [640, 640], [768, 768]]
  normalize_mean: [0.485, 0.456, 0.406]
  normalize_std: [0.229, 0.224, 0.225]
  use_cache: false  # 禁用缓存以避免损坏问题
  cache_dir: "./cache"
  min_mask_ratio: 0.001
  mixup_prob: 0.25
  cutmix_prob: 0.35
  mix_alpha: 0.6
  focus_crop_prob: 0.6
  hard_mining_update_interval: 128

# 模型配置
model:
  backbone: "convnext_small"  # convnext_tiny, convnext_small, convnext_base
  pretrained: "../convnext_small.bin"
  num_classes: 1
  decoder_channels: 320
  deep_supervision: true
  edge_branch: true
  head_dropout: 0.3

# 损失函数配置
loss:
  type: "combined"
  dice: 0.35
  focal: 0.3
  bce: 0.2
  boundary: 0.15
  focal_gamma: 2.0
  use_tversky: true
  tversky_beta: 0.6

# 优化器配置
optimizer:
  type: "adamw"
  lr: 0.001
  weight_decay: 0.0005

# 学习率调度器配置
scheduler:
  type: "cosine_warmup"  # onecycle, cosine, plateau, cosine_warmup
  warmup_epochs: 8
  warmup_start_factor: 0.1
  min_lr: 0.00005

# 训练配置
training:
  epochs: 300
  batch_size: 4
  num_workers: 4
  output_dir: "./outputs"
  
  # 混合精度训练
  use_amp: true
  
  # 指数移动平均
  use_ema: true
  ema_decay: 0.9995
  
  # 随机权重平均
  use_swa: true
  swa_start_epoch: 180
  
  # 梯度配置
  gradient_accumulation_steps: 2
  max_grad_norm: 1.0
  
  # 早停
  early_stopping_patience: 15

# 推理配置
inference:
  # 滑窗配置（高分辨率图像）
  sliding_window:
    enabled: true
    window_size: [1024, 1024]
    overlap: 0.25
    batch_size: 4
    blend_mode: "gaussian"
  
  # TTA配置
  tta:
    enabled: true
    scales: [0.75, 1.0, 1.25]
    flip_h: true
    flip_v: true
  
  # 后处理
  postprocess:
    threshold: 0.5
    min_area: 50
    morphology:
      enabled: true
      kernel_size: 3
      operations: ["open", "close"]

# 评估配置
evaluation:
  metrics:
    - "iou"
    - "dice"
    - "precision"
    - "recall"
    - "f1"
  
  # 边界评估
  boundary_metrics:
    enabled: true
    tolerance: 2  # 像素

# 日志配置
logging:
  log_interval: 50
  save_checkpoint_interval: 5
  tensorboard: true
  wandb:
    enabled: false
    project: "crack-detection"
    entity: "your-entity"

# 硬件配置
hardware:
  gpu_ids: [0]
  distributed: false
  num_gpus: 1
  
# 随机种子
seed: 42

