# 优化后的裂纹检测训练配置 v4
# DeepCrack论文风格增强 + 额外性能优化

# 数据集配置
dataset:
  root: "../data/cracktree260"
  image_dir: "images"
  mask_dir: "masks"
  crop_size: [512, 512]
  train_scales: [[512, 512]]  # DeepCrack论文使用固定512x512
  normalize_mean: [0.485, 0.456, 0.406]
  normalize_std: [0.229, 0.224, 0.225]
  use_cache: false
  cache_dir: "./cache"
  min_mask_ratio: 0.0001  # 降低阈值，保留更多样本
  # MixUp/CutMix - 可以帮助正则化和泛化
  mixup_prob: 0.15    # 适度使用MixUp
  cutmix_prob: 0.15   # 适度使用CutMix
  mix_alpha: 0.4      # 较小的alpha避免过度混合
  focus_crop_prob: 0.3  # 30%概率聚焦裁剪裂纹区域
  hard_mining_update_interval: 256
  
# 模型配置
model:
  backbone: "convnext_small"
  pretrained: "../convnext_small.bin"
  num_classes: 1
  decoder_channels: 256
  deep_supervision: true
  edge_branch: true
  head_dropout: 0.15  # 略微降低dropout
  drop_path_rate: 0.15  # 增加DropPath正则化

# 损失函数配置 - 增加Dice权重
loss:
  type: "combined"
  dice: 0.45      # 增加Dice权重（对小目标友好）
  focal: 0.30
  bce: 0.15       # 降低BCE
  boundary: 0.10  # 保持边界损失
  focal_gamma: 2.0
  use_tversky: true
  tversky_beta: 0.7  # 增加beta，更关注召回率

# 优化器配置
optimizer:
  type: "adamw"
  lr: 0.0004  # 略微降低
  weight_decay: 0.0001

# 学习率调度器配置
scheduler:
  type: "cosine_warmup"
  warmup_epochs: 10
  warmup_start_factor: 0.1
  min_lr: 0.000005  # 进一步降低最小学习率

# 训练配置
training:
  epochs: 500  # 在线增强需要更多epochs来弥补数据量差距
  batch_size: 4
  num_workers: 4
  output_dir: "./outputs_v3"  # 新输出目录
  
  use_amp: true
  use_ema: true
  ema_decay: 0.9995
  use_swa: true
  swa_start_epoch: 250  # 在更多epochs后启动SWA
  swa_lr: 0.0001        # SWA使用固定低学习率
  
  gradient_accumulation_steps: 2
  max_grad_norm: 0.5
  
  early_stopping_patience: 60  # 增加patience，在线增强收敛较慢

# 推理配置
inference:
  sliding_window:
    enabled: true
    window_size: [1024, 1024]
    overlap: 0.25
    batch_size: 4
    blend_mode: "gaussian"
  
  tta:
    enabled: true
    scales: [0.75, 1.0, 1.25]
    flip_h: true
    flip_v: true
  
  postprocess:
    threshold: 0.5
    min_area: 50
    morphology:
      enabled: true
      kernel_size: 3
      operations: ["open", "close"]

# 评估配置
evaluation:
  metrics: ["iou", "dice", "precision", "recall", "f1"]
  boundary_metrics:
    enabled: true
    tolerance: 2

# 日志配置
logging:
  log_interval: 50
  save_checkpoint_interval: 5
  tensorboard: true
  wandb:
    enabled: false
    project: "crack-detection"

# 硬件配置
hardware:
  gpu_ids: [0]
  distributed: false
  num_gpus: 1

seed: 42
